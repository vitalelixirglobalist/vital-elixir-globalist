<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medicines – Vital Elixir Globalist</title>
  <meta name="description" content="Browse our full catalog of medicines and export-ready treatments." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="currency-utils.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: '#0284c7' },
          boxShadow: {
            glow: '0 12px 45px rgba(2, 132, 199, 0.18)'
          }
        }
      }
    };
  </script>
</head>

<body class="bg-slate-50 text-slate-800">
  <div id="header-placeholder"></div>

  <main class="max-w-6xl mx-auto px-4 pb-24 pt-10 space-y-8">
    <header class="space-y-2">
      <p id="resultsSubtitle" class="text-sm uppercase tracking-wide text-brand font-semibold">All medicines</p>
      <h1 id="resultsTitle" class="text-3xl md:text-4xl font-extrabold text-slate-900">Medicines</h1>
      <p id="resultsMeta" class="text-sm text-slate-600"></p>
    </header>

    <section id="productsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></section>
  </main>

  <footer class="py-8 bg-white border-t text-center text-slate-500 text-sm">
    © <span id="year"></span> Vital Elixir Globalist. All rights reserved.
  </footer>

  <script>
    const productsGrid = document.getElementById('productsGrid');
    const resultsTitle = document.getElementById('resultsTitle');
    const resultsSubtitle = document.getElementById('resultsSubtitle');
    const resultsMeta = document.getElementById('resultsMeta');
    let filteredProducts = [];

    document.getElementById('year').textContent = new Date().getFullYear();

    function formatMoney(value) {
      return Number(value || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function getSelectedCurrency() {
      return window.currencyUtils?.getSelectedCurrency?.() || 'GBP';
    }

    function formatForeignCurrency(value) {
      const currency = getSelectedCurrency();
      const converted = window.currencyUtils?.convertFromUsd
        ? window.currencyUtils.convertFromUsd(value, currency)
        : value;
      return `${currency} ${formatMoney(converted)}`;
    }

    function getFilters() {
      const params = new URLSearchParams(window.location.search);
      return {
        search: (params.get('search') || '').trim(),
        category: (params.get('category') || '').trim()
      };
    }

    function matchesFilter(product, filters) {
      const loweredSearch = filters.search.toLowerCase();
      const loweredCategory = filters.category.toLowerCase();

      if (loweredCategory && product.category.toLowerCase() !== loweredCategory) {
        return false;
      }

      if (!loweredSearch) {
        return true;
      }

      return (
        product.name.toLowerCase().includes(loweredSearch) ||
        product.category.toLowerCase().includes(loweredSearch) ||
        product.brand.toLowerCase().includes(loweredSearch)
      );
    }

    function renderProducts(products, filters) {
      productsGrid.innerHTML = '';

      if (!products.length) {
        productsGrid.innerHTML = '<p class="text-sm text-slate-500">No medicines found for this selection.</p>';
        resultsMeta.textContent = '';
        return;
      }

      resultsMeta.textContent = `${products.length} medicine${products.length === 1 ? '' : 's'} available.`;

      products.forEach((product) => {
        const card = document.createElement('a');
        const startingPrice = product.variants?.length ? formatForeignCurrency(product.variants[0].price_usd) : '';
        card.href = `product-details.html?product=${encodeURIComponent(product.name)}`;
        card.className = 'bg-white border border-slate-200 rounded-2xl p-5 shadow-sm hover:shadow-lg transition flex flex-col gap-4';
        card.innerHTML = `
          <div class="h-40 bg-slate-100 rounded-xl flex items-center justify-center overflow-hidden">
            <img src="${product.image}" alt="${product.name}" class="max-h-32 w-auto object-contain" />
          </div>
          <div class="space-y-2">
            <p class="text-xs uppercase tracking-wide text-brand font-semibold">${product.category}</p>
            <h2 class="text-lg font-bold text-slate-900">${product.name}</h2>
            <p class="text-sm text-slate-500">${product.brand}</p>
            ${startingPrice ? `<p class="text-sm text-slate-600">Starting from <span class="font-semibold text-slate-900">${startingPrice}</span></p>` : ''}
          </div>
          <div class="mt-auto text-sm font-semibold text-brand">View details →</div>
        `;
        productsGrid.appendChild(card);
      });
    }

    function updateHeading(filters) {
      if (filters.category) {
        resultsSubtitle.textContent = 'Category';
        resultsTitle.textContent = filters.category;
      } else if (filters.search) {
        resultsSubtitle.textContent = 'Search results';
        resultsTitle.textContent = `Results for “${filters.search}”`;
      } else {
        resultsSubtitle.textContent = 'All medicines';
        resultsTitle.textContent = 'Medicines';
      }
    }

    async function loadProducts() {
      try {
        const res = await fetch('products-data.json');
        const products = await res.json();
        const filters = getFilters();
        updateHeading(filters);
        filteredProducts = products.filter((product) => matchesFilter(product, filters));
        renderProducts(filteredProducts, filters);
      } catch (error) {
        console.error('Failed to load products', error);
        productsGrid.innerHTML = '<p class="text-sm text-slate-500">Unable to load medicines right now.</p>';
      }
    }

    async function loadHeader() {
      const header = await fetch('header.html');
      document.getElementById('header-placeholder').innerHTML = await header.text();
      if (window.initCurrencySelect) {
        window.initCurrencySelect();
      }
      const menuBtn = document.getElementById('menu-btn');
      const closeBtn = document.getElementById('close-menu');
      const mobileMenu = document.getElementById('mobile-menu');
      const sidebar = document.getElementById('sidebar');
      if (!menuBtn || !sidebar || !mobileMenu || !closeBtn) return;
      menuBtn.addEventListener('click', () => {
        mobileMenu.classList.remove('hidden');
        setTimeout(() => sidebar.classList.remove('translate-x-full'), 10);
      });
      closeBtn.addEventListener('click', () => {
        sidebar.classList.add('translate-x-full');
        setTimeout(() => mobileMenu.classList.add('hidden'), 300);
      });
      mobileMenu.addEventListener('click', (e) => {
        if (e.target === mobileMenu) {
          sidebar.classList.add('translate-x-full');
          setTimeout(() => mobileMenu.classList.add('hidden'), 300);
        }
      });
    }

    document.addEventListener('currency:change', () => {
      if (filteredProducts.length) {
        renderProducts(filteredProducts, getFilters());
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadHeader();
      loadProducts();
    });
  </script>
  <script type="module" src="firebase-config.js"></script>
</body>
</html>
